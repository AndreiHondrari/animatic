/*
    AnimaticJS - JavaScript library for execution orchestration.

    Author: Andrei-George Hondrari
    E-mail: andrei.hondrari@gmail.com
    Website: https://andreihondrari.com
    Github: https://github.com/AndreiHondrari
    Created on: July 2019
*/


var Animatic=function(){"use strict";var l=Object.freeze({RUNNING:Symbol("RUNNING"),PAUSED:Symbol("PAUSED"),COMPLETED:Symbol("COMPLETED")}),c=Object.freeze({FORWARD:Symbol("FORWARD"),BACKWARD:Symbol("BACKWARD")});function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function i(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}function a(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function h(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{r||null==s.return||s.return()}finally{if(i)throw o}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var t=function(){function t(){n(this,t)}return i(t,[{key:"forward",value:function(){throw Error("Not implemented!")}},{key:"pause",value:function(){throw Error("Not implemented!")}},{key:"backward",value:function(){throw Error("Not implemented!")}},{key:"adaptee",get:function(){throw Error("Not implemented!")}}]),t}(),e=function(){function e(t){n(this,e),this._handler=t.handler||null,this._backwardFunction=t.backward||null,this._pauseFunction=t.pause||null,this._resetFunction=t.reset||null,this._isFunctionHandler=t.handler instanceof Function,this._id=e._getNewId(),this._orchestra=null,this._animationStatus=l.PAUSED,this._previousNodes=new Map,this._previousCountdown=0,this._nextNodes=new Map,this._nextCountdown=0}return i(e,null,[{key:"_getNewId",value:function(){return this._idCounter++}}]),i(e,[{key:"to",value:function(t){if(null===this.orchestra)throw Error("Can't append to a stray node! Add it as an orchestra root first!");if(this.orchestra.animationStarted)throw Error("Can't add new animatic nodes once the orchestration started!");return t.orchestra=this.orchestra,this.orchestra._nodes.set(t.id,t),this._nextNodes.set(t.id,t),t._previousNodes.set(this.id,this),t._previousCountdown++,t}},{key:"split",value:function(t){var e;if(null!==this.orchestra){for(var n=arguments.length,r=new Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];(e=this.orchestra).split.apply(e,[this,t].concat(r))}}},{key:"unite",value:function(t){var e;if(null!==this.orchestra){for(var n=arguments.length,r=new Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return(e=this.orchestra).split.apply(e,[this,t].concat(r)),this}}},{key:"forward",value:function(){this._animationStatus=l.RUNNING;var a=this;function t(){a._animationStatus=l.COMPLETED,0!=a.nextCount?a.orchestra.disableNode(a.id):a.orchestra.touchEnd(),a._nextCountdown=a.nextCount;var t=!0,e=!1,n=void 0;try{for(var r,i=a._nextNodes[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var o=h(r.value,2);o[0];o[1].forward()}}catch(t){e=!0,n=t}finally{try{t||null==i.return||i.return()}finally{if(e)throw n}}}this._previousCountdown--,0<this._previousCountdown||(this._previousCountdown=0,this.orchestra.activateNode(this.id),this._isFunctionHandler?(null===this._handler&&t(),this._handler(t)):this._handler.forward(t))}},{key:"pause",value:function(){null!==this._pauseFunction&&(this._animationStatus=l.PAUSED,this._isFunctionHandler?this._pauseFunction():this._handler.pause())}},{key:"backward",value:function(){this._animationStatus=l.RUNNING;var a=this;function t(){a._animationStatus=l.COMPLETED,0!=a.previousCount?a.orchestra.disableNode(a.id):a.orchestra.touchStart(),a._previousCountdown=a.previousCount;var t=!0,e=!1,n=void 0;try{for(var r,i=a._previousNodes[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var o=h(r.value,2);o[0];o[1].backward()}}catch(t){e=!0,n=t}finally{try{t||null==i.return||i.return()}finally{if(e)throw n}}}this._nextCountdown--,0<this._nextCountdown||(this._nextCountdown=0,this.orchestra.activateNode(this.id),this._isFunctionHandler?(null===this._backwardFunction&&t(),this._backwardFunction(t)):this._handler.backward(t))}},{key:"reset",value:function(){null!==this._resetFunction&&(this._animationStatus=l.PAUSED,this._isFunctionHandler?this._resetFunction():this._handler.reset())}},{key:"id",get:function(){return this._id}},{key:"orchestra",get:function(){return this._orchestra},set:function(t){if(null!==this._orchestra&&this._orchestra!=t)throw Error("AnimaticNode with id ".concat(this.id," already belongs to an orchestra!"));this._orchestra=t}},{key:"previousCount",get:function(){return this._previousNodes.size}},{key:"previousCountdown",get:function(){return this._previousCountdown}},{key:"nextCount",get:function(){return this._nextNodes.size}},{key:"nextCountdown",get:function(){return this._nextCountdown}},{key:"status",get:function(){return this._animationStatus}}]),e}();a(e,"_idCounter",0);var o=function(){function t(){n(this,t),this._rootNodes=new Map,this._nodes=new Map,this._activeNodes=new Map,this._isAnimationStarted=!1,this._onBeginCallbacks=new Array,this._onCompleteCallbacks=new Array,this._onCompletePromises=new Array,this._animationStatus=l.PAUSED}return i(t,[{key:"add",value:function(t){if(this._isAnimationStarted)throw Error("Can't add new animatic nodes once the orchestration started!");return this._rootNodes.set(t.id,t),this._activeNodes.set(t.id,t),this._nodes.set(t.id,t),t.orchestra=this,t}},{key:"_splitList",value:function(t,e){var n=!0,r=!1,i=void 0;try{for(var o,a=e[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value;t.to(s)}}catch(t){r=!0,i=t}finally{try{n||null==a.return||a.return()}finally{if(r)throw i}}}},{key:"split",value:function(t,e){if(!this._nodes.has(t.id))throw Error("".concat(t," is not part of the orchestra!"));if(e instanceof Array){var n=e;this._splitList(t,n)}else{t.to(e);for(var r=arguments.length,i=new Array(2<r?r-2:0),o=2;o<r;o++)i[o-2]=arguments[o];this._splitList(t,i)}}},{key:"_uniteList",value:function(t,e){var n=!0,r=!1,i=void 0;try{for(var o,a=e[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){o.value.to(t)}}catch(t){r=!0,i=t}finally{try{n||null==a.return||a.return()}finally{if(r)throw i}}}},{key:"unite",value:function(t,e){if(e instanceof Array){var n=e;this._uniteList(t,n)}else{e.to(t);for(var r=arguments.length,i=new Array(2<r?r-2:0),o=2;o<r;o++)i[o-2]=arguments[o];this._uniteList(t,i)}return t}},{key:"play",value:function(){this._animationStatus=l.RUNNING;var t=!0,e=!1,n=void 0;try{for(var r,i=this._rootNodes[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var o=h(r.value,2);o[0];o[1].forward()}}catch(t){e=!0,n=t}finally{try{t||null==i.return||i.return()}finally{if(e)throw n}}}},{key:"pause",value:function(){this._animationStatus=l.PAUSED;var t=!0,e=!1,n=void 0;try{for(var r,i=new Map(this._activeNodes)[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var o=h(r.value,2);o[0];o[1].pause()}}catch(t){e=!0,n=t}finally{try{t||null==i.return||i.return()}finally{if(e)throw n}}}},{key:"reset",value:function(){this._animationStatus=l.PAUSED;var t=!0,e=!1,n=void 0;try{for(var r,i=this._nodes[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var o=h(r.value,2);o[0];o[1].reset()}}catch(t){e=!0,n=t}finally{try{t||null==i.return||i.return()}finally{if(e)throw n}}this._activeNodes=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(n,!0).forEach(function(t){a(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(n).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({},this._rootNodes)}},{key:"reverse",value:function(){this._animationStatus=l.RUNNING;var t=!0,e=!1,n=void 0;try{for(var r,i=new Map(this._activeNodes)[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var o=h(r.value,2);o[0];o[1].backward()}}catch(t){e=!0,n=t}finally{try{t||null==i.return||i.return()}finally{if(e)throw n}}}},{key:"onBegin",value:function(t){this._onBeginCallbacks.push(t)}},{key:"onComplete",value:function(t){this._onCompleteCallbacks.push(t)}},{key:"_callBegan",value:function(){var t=!0,e=!1,n=void 0;try{for(var r,i=this._onBeginCallbacks[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){(0,r.value)()}}catch(t){e=!0,n=t}finally{try{t||null==i.return||i.return()}finally{if(e)throw n}}}},{key:"_callCompleted",value:function(t){var e=!0,n=!1,r=void 0;try{for(var i,o=this._onCompleteCallbacks[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){(0,i.value)(t)}}catch(t){n=!0,r=t}finally{try{e||null==o.return||o.return()}finally{if(n)throw r}}var a=!0,s=!1,u=void 0;try{for(var l,c=this._onCompletePromises[Symbol.iterator]();!(a=(l=c.next()).done);a=!0){(0,l.value)(t)}}catch(t){s=!0,u=t}finally{try{a||null==c.return||c.return()}finally{if(s)throw u}}this._onCompletePromises=new Array}},{key:"activateNode",value:function(t){this._activeNodes.set(t,this._nodes.get(t))}},{key:"disableNode",value:function(t){this._activeNodes.delete(t)}},{key:"touchStart",value:function(){var t=0,e=!1,n=!0,r=!1,i=void 0;try{for(var o,a=this._activeNodes[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=h(o.value,2),u=(s[0],s[1]);t+=u.previousCount,e=e||u.status!=l.COMPLETED}}catch(t){r=!0,i=t}finally{try{n||null==a.return||a.return()}finally{if(r)throw i}}0!=t||e||(this._animationStatus=l.COMPLETED,this._callCompleted(c.BACKWARD))}},{key:"touchEnd",value:function(){var t=0,e=!1,n=!0,r=!1,i=void 0;try{for(var o,a=this._activeNodes[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=h(o.value,2),u=(s[0],s[1]);t+=u.nextCount,e=e||u.status!=l.COMPLETED}}catch(t){r=!0,i=t}finally{try{n||null==a.return||a.return()}finally{if(r)throw i}}0!=t||e||(this._animationStatus=l.COMPLETED,this._callCompleted(c.FORWARD))}},{key:"rootNodes",get:function(){return this._rootNodes}},{key:"allNodes",get:function(){return this._nodes}},{key:"activeNodes",get:function(){return this._activeNodes}},{key:"animationStarted",get:function(){return this._isAnimationStarted}},{key:"finished",get:function(){var n=this;return new Promise(function(e,t){n._onCompletePromises.push(function(t){e(t)})})}},{key:"status",get:function(){return this._animationStatus}}]),t}();return{AnimationStatus:l,AnimationDirection:c,AbstractAnimaticAdapterNode:t,AnimaticNode:e,AnimaticOrchestra:o,orchestra:function(){return new o},node:function(t){return new e(t)}}}();
