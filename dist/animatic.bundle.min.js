/*
    AnimaticJS - JavaScript library for execution orchestration.

    Author: Andrei-George Hondrari
    E-mail: andrei.hondrari@gmail.com
    Website: https://andreihondrari.com
    Github: https://github.com/AndreiHondrari
    Created on: July 2019
*/


"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(n,!0).forEach(function(t){_defineProperty(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(n).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{r||null==s.return||s.return()}finally{if(i)throw o}}return n}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}var Animatic=function(){var l=Object.freeze({RUNNING:Symbol("RUNNING"),PAUSED:Symbol("PAUSED"),COMPLETED:Symbol("COMPLETED")}),e=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"forward",value:function(){throw Error("Not implemented!")}},{key:"pause",value:function(){throw Error("Not implemented!")}},{key:"backward",value:function(){throw Error("Not implemented!")}},{key:"adaptee",get:function(){throw Error("Not implemented!")}}]),t}(),n=function(){function e(t){_classCallCheck(this,e),this._handler=t.handler||null,this._backwardFunction=t.backward||null,this._pauseFunction=t.pause||null,this._resetFunction=t.reset||null,this._isFunctionHandler=t.handler instanceof Function,this._id=e._getNewId(),this._orchestra=null,this._animationStatus=l.PAUSED,this._previousNodes=new Map,this._previousCountdown=0,this._nextNodes=new Map,this._nextCountdown=0}return _createClass(e,null,[{key:"_getNewId",value:function(){return this._idCounter++}}]),_createClass(e,[{key:"to",value:function(t){if(null===this.orchestra)throw Error("Can't append to a stray node! Add it as an orchestra root first!");if(this.orchestra.animationStarted)throw Error("Can't add new animatic nodes once the orchestration started!");return t.orchestra=this.orchestra,this.orchestra._nodes.set(t.id,t),this._nextNodes.set(t.id,t),t._previousNodes.set(this.id,this),t._previousCountdown++,t}},{key:"split",value:function(t){var e;if(null!==this.orchestra){for(var n=arguments.length,r=new Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];(e=this.orchestra).split.apply(e,[this,t].concat(r))}}},{key:"unite",value:function(t){var e;if(null!==this.orchestra){for(var n=arguments.length,r=new Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return(e=this.orchestra).split.apply(e,[this,t].concat(r)),this}}},{key:"forward",value:function(){this._animationStatus=l.RUNNING;var a=this;function t(){a._animationStatus=l.COMPLETED,0!=a.nextCount?a.orchestra.disableNode(a.id):a.orchestra.touchEnd(),a._nextCountdown=a.nextCount;var t=!0,e=!1,n=void 0;try{for(var r,i=a._nextNodes[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var o=_slicedToArray(r.value,2);o[0];o[1].forward()}}catch(t){e=!0,n=t}finally{try{t||null==i.return||i.return()}finally{if(e)throw n}}}this._previousCountdown--,0<this._previousCountdown||(this._previousCountdown=0,this.orchestra.activateNode(this.id),this._isFunctionHandler?(null===this._handler&&t(),this._handler(t)):this._handler.forward(t))}},{key:"pause",value:function(){null!==this._pauseFunction&&(this._animationStatus=l.PAUSED,this._isFunctionHandler?this._pauseFunction():this._handler.pause())}},{key:"backward",value:function(){this._animationStatus=l.RUNNING;var a=this;function t(){a._animationStatus=l.COMPLETED,0!=a.previousCount?a.orchestra.disableNode(a.id):a.orchestra.touchStart(),a._previousCountdown=a.previousCount;var t=!0,e=!1,n=void 0;try{for(var r,i=a._previousNodes[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var o=_slicedToArray(r.value,2);o[0];o[1].backward()}}catch(t){e=!0,n=t}finally{try{t||null==i.return||i.return()}finally{if(e)throw n}}}this._nextCountdown--,0<this._nextCountdown||(this._nextCountdown=0,this.orchestra.activateNode(this.id),this._isFunctionHandler?(null===this._backwardFunction&&t(),this._backwardFunction(t)):this._handler.backward(t))}},{key:"reset",value:function(){null!==this._resetFunction&&(this._animationStatus=l.PAUSED,this._isFunctionHandler?this._resetFunction():this._handler.reset())}},{key:"id",get:function(){return this._id}},{key:"orchestra",get:function(){return this._orchestra},set:function(t){if(null!==this._orchestra&&this._orchestra!=t)throw Error("AnimaticNode with id ".concat(this.id," already belongs to an orchestra!"));this._orchestra=t}},{key:"previousCount",get:function(){return this._previousNodes.size}},{key:"previousCountdown",get:function(){return this._previousCountdown}},{key:"nextCount",get:function(){return this._nextNodes.size}},{key:"nextCountdown",get:function(){return this._nextCountdown}},{key:"status",get:function(){return this._animationStatus}}]),e}();_defineProperty(n,"_idCounter",0);var r=function(){function t(){_classCallCheck(this,t),this._rootNodes=new Map,this._nodes=new Map,this._activeNodes=new Map,this._isAnimationStarted=!1,this._onBeginCallbacks=new Array,this._onCompleteCallbacks=new Array,this._animationStatus=l.PAUSED}return _createClass(t,[{key:"add",value:function(t){if(this._isAnimationStarted)throw Error("Can't add new animatic nodes once the orchestration started!");return this._rootNodes.set(t.id,t),this._activeNodes.set(t.id,t),this._nodes.set(t.id,t),t.orchestra=this,t}},{key:"_splitList",value:function(t,e){var n=!0,r=!1,i=void 0;try{for(var o,a=e[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value;t.to(s)}}catch(t){r=!0,i=t}finally{try{n||null==a.return||a.return()}finally{if(r)throw i}}}},{key:"split",value:function(t,e){if(!this._nodes.has(t.id))throw Error("".concat(t," is not part of the orchestra!"));if(e instanceof Array){var n=e;this._splitList(t,n)}else{t.to(e);for(var r=arguments.length,i=new Array(2<r?r-2:0),o=2;o<r;o++)i[o-2]=arguments[o];this._splitList(t,i)}}},{key:"_uniteList",value:function(t,e){var n=!0,r=!1,i=void 0;try{for(var o,a=e[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){o.value.to(t)}}catch(t){r=!0,i=t}finally{try{n||null==a.return||a.return()}finally{if(r)throw i}}}},{key:"unite",value:function(t,e){if(e instanceof Array){var n=e;this._uniteList(t,n)}else{e.to(t);for(var r=arguments.length,i=new Array(2<r?r-2:0),o=2;o<r;o++)i[o-2]=arguments[o];this._uniteList(t,i)}return t}},{key:"play",value:function(){this._animationStatus=l.RUNNING;var t=!0,e=!1,n=void 0;try{for(var r,i=this._rootNodes[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var o=_slicedToArray(r.value,2);o[0];o[1].forward()}}catch(t){e=!0,n=t}finally{try{t||null==i.return||i.return()}finally{if(e)throw n}}}},{key:"pause",value:function(){this._animationStatus=l.PAUSED;var t=!0,e=!1,n=void 0;try{for(var r,i=new Map(this._activeNodes)[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var o=_slicedToArray(r.value,2);o[0];o[1].pause()}}catch(t){e=!0,n=t}finally{try{t||null==i.return||i.return()}finally{if(e)throw n}}}},{key:"reset",value:function(){this._animationStatus=l.PAUSED;var t=!0,e=!1,n=void 0;try{for(var r,i=this._nodes[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var o=_slicedToArray(r.value,2);o[0];o[1].reset()}}catch(t){e=!0,n=t}finally{try{t||null==i.return||i.return()}finally{if(e)throw n}}this._activeNodes=_objectSpread({},this._rootNodes)}},{key:"reverse",value:function(){this._animationStatus=l.RUNNING;var t=!0,e=!1,n=void 0;try{for(var r,i=new Map(this._activeNodes)[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var o=_slicedToArray(r.value,2);o[0];o[1].backward()}}catch(t){e=!0,n=t}finally{try{t||null==i.return||i.return()}finally{if(e)throw n}}}},{key:"onBegin",value:function(t){this._onBeginCallbacks.push(t)}},{key:"onComplete",value:function(t){this._onCompleteCallbacks.push(t)}},{key:"_callBegan",value:function(){var t=!0,e=!1,n=void 0;try{for(var r,i=this._onBeginCallbacks[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){(0,r.value)()}}catch(t){e=!0,n=t}finally{try{t||null==i.return||i.return()}finally{if(e)throw n}}}},{key:"_callCompleted",value:function(){var t=!0,e=!1,n=void 0;try{for(var r,i=this._onCompleteCallbacks[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){(0,r.value)()}}catch(t){e=!0,n=t}finally{try{t||null==i.return||i.return()}finally{if(e)throw n}}}},{key:"activateNode",value:function(t){this._activeNodes.set(t,this._nodes.get(t))}},{key:"disableNode",value:function(t){this._activeNodes.delete(t)}},{key:"touchStart",value:function(){var t=0,e=!1,n=!0,r=!1,i=void 0;try{for(var o,a=this._activeNodes[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=_slicedToArray(o.value,2),u=(s[0],s[1]);t+=u.previousCount,e=e||u.status!=l.COMPLETED}}catch(t){r=!0,i=t}finally{try{n||null==a.return||a.return()}finally{if(r)throw i}}0!=t||e||(this._animationStatus=l.COMPLETED,this._callCompleted())}},{key:"touchEnd",value:function(){var t=0,e=!1,n=!0,r=!1,i=void 0;try{for(var o,a=this._activeNodes[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=_slicedToArray(o.value,2),u=(s[0],s[1]);t+=u.nextCount,e=e||u.status!=l.COMPLETED}}catch(t){r=!0,i=t}finally{try{n||null==a.return||a.return()}finally{if(r)throw i}}0!=t||e||(this._animationStatus=l.COMPLETED,this._callCompleted())}},{key:"rootNodes",get:function(){return this._rootNodes}},{key:"allNodes",get:function(){return this._nodes}},{key:"activeNodes",get:function(){return this._activeNodes}},{key:"animationStarted",get:function(){return this._isAnimationStarted}},{key:"finished",get:function(){return new Promise(function(t,e){})}},{key:"status",get:function(){return this._animationStatus}}]),t}();return new(function(){function t(){_classCallCheck(this,t),_defineProperty(this,"AnimationStatus",l),_defineProperty(this,"AbstractAnimaticAdapterNode",e),_defineProperty(this,"AnimaticNode",n),_defineProperty(this,"AnimaticOrchestra",r)}return _createClass(t,[{key:"orchestra",value:function(){return new r}},{key:"node",value:function(t){return new n(t)}}]),t}())}();!function(){var e=function(){function n(t){var e;return _classCallCheck(this,n),e=_possibleConstructorReturn(this,_getPrototypeOf(n).call(this)),t.autoplay=!1,e._animationInstance=anime(t),e}return _inherits(n,Animatic.AbstractAnimaticAdapterNode),_createClass(n,[{key:"forward",value:function(t){this._animationInstance.finished.then(function(){t()}),this._animationInstance.direction="normal",this._animationInstance.play()}},{key:"pause",value:function(){this._animationInstance.pause()}},{key:"backward",value:function(t){var e=this;this._animationInstance.finished.then(function(){t()}),setTimeout(function(){e._animationInstance.direction="reverse",e._animationInstance.play()},0)}},{key:"adaptee",get:function(){return this._animationInstance}}]),n}(),n=function(){function c(t){var e;_classCallCheck(this,c),e=_possibleConstructorReturn(this,_getPrototypeOf(c).call(this));var n=t.opts||{},r=t.nodes||[];n.autoplay=!1,e._timelineInstance=anime.timeline(n);var i=!0,o=!1,a=void 0;try{for(var s,u=r[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=s.value;e._timelineInstance.add(l)}}catch(t){o=!0,a=t}finally{try{i||null==u.return||u.return()}finally{if(o)throw a}}return e}return _inherits(c,Animatic.AbstractAnimaticAdapterNode),_createClass(c,[{key:"forward",value:function(t){this._timelineInstance.finished.then(function(){t()}),this._timelineInstance.direction="normal",this._timelineInstance.play()}},{key:"pause",value:function(){this._timelineInstance.pause()}},{key:"backward",value:function(t){this._timelineInstance.finished.then(function(){t()}),this._timelineInstance.direction="reverse",this._timelineInstance.play()}},{key:"adaptee",get:function(){return this._timelineInstance}}]),c}();Animatic.AnimeAdapterNode=e,Animatic.AnimeTimelineAdapterNode=n,Animatic.animeNode=function(t){return Animatic.node({handler:new e(t)})},Animatic.animeTimelineNode=function(t){return Animatic.node({handler:new n(t)})}}();